{% extends "base.html" %}

{% block content %}
<h2>Lista Książek</h2>
<div id="authStatus" style="margin-bottom: 20px;"></div>

<div id="booksContainer">
    <ul id="booksList"></ul>
</div>

<div id="editSection" style="display:none; border: 1px solid #ccc; padding: 20px; margin-top: 20px; background-color: #f9f9f9;">
    <h3>Edytuj Książkę (ID: <span id="editId"></span>)</h3>
    
    <div style="margin-bottom: 10px;">
        <label>Tytuł:</label><br>
        <input type="text" id="editTitle" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 10px;">
        <label>Autor:</label><br>
        <input type="text" id="editAuthor" style="width: 100%;">
    </div>

    <div style="margin-bottom: 10px;">
        <label>Rok wydania:</label><br>
        <input type="number" id="editYear">
    </div>

    <div style="margin-bottom: 10px;">
        <label>Opis:</label><br>
        <textarea id="editDescription" rows="4" style="width: 100%;"></textarea>
    </div>

    <button onclick="submitEdit()">Zapisz zmiany</button>
    <button onclick="closeEdit()">Anuluj</button>
</div>

<script>
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    
    let allBooks = []; 

    if (token) {
        document.getElementById('authStatus').innerHTML = `Zalogowany jako: <b>${user}</b> <button onclick="logout()">Wyloguj</button>`;
    } else {
        document.getElementById('authStatus').innerHTML = `Tylko zalogowani użytkownicy mogą edytować. <a href="/login">Zaloguj się</a>`;
    }

    async function loadBooks() {
        try {
            const response = await fetch('/books/');
            allBooks = await response.json();
            
            const list = document.getElementById('booksList');
            list.innerHTML = '';
            
            allBooks.forEach(book => {
                const li = document.createElement('li');
                li.style.marginBottom = "15px";
                
                const editBtn = token ? ` <button onclick="openEdit(${book.id})">Edytuj</button>` : '';
                
                li.innerHTML = `
                    <strong>${book.title}</strong> (${book.year || 'brak roku'}) <br>
                    <small>Autor: ${book.author}</small><br>
                    <em>${book.description || 'Brak opisu.'}</em>
                    <div style="margin-top: 5px;">${editBtn}</div>
                `;
                list.appendChild(li);
            });
        } catch (error) {
            console.error('Błąd pobierania książek:', error);
        }
    }

    function openEdit(id) {
        const book = allBooks.find(b => b.id === id);
        if (!book) return;

        document.getElementById('editSection').style.display = 'block';
        document.getElementById('editId').innerText = book.id;
        
        document.getElementById('editTitle').value = book.title;
        document.getElementById('editAuthor').value = book.author;
        document.getElementById('editYear').value = book.year || '';
        document.getElementById('editDescription').value = book.description || '';
        
        document.getElementById('editSection').scrollIntoView({behavior: "smooth"});
    }

    function closeEdit() {
        document.getElementById('editSection').style.display = 'none';
    }

    async function submitEdit() {
        const id = document.getElementById('editId').innerText;
        
        const updatedBook = {
            title: document.getElementById('editTitle').value,
            author: document.getElementById('editAuthor').value,
            year: document.getElementById('editYear').value ? parseInt(document.getElementById('editYear').value) : null,
            description: document.getElementById('editDescription').value
        };

        const response = await fetch(`/books/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(updatedBook)
        });

        if (response.ok) {
            alert("Zaktualizowano pomyślnie!");
            closeEdit();
            loadBooks();
        } else {
            const err = await response.json();
            alert("Błąd: " + (err.detail || "Nie udało się zapisać"));
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.reload();
    }

    loadBooks();
</script>
{% endblock %}